<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Kingdom ü¶Å</title>
    <script src="data.js"></script> 
    <style>
        :root {
            --primary-green: #2ecc71;
            --dark-green: #27ae60;
            --jungle-bg: #e8f5e9;
            --accent-orange: #f39c12;
            --danger-red: #e74c3c;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--jungle-bg);
            background-image: radial-gradient(var(--primary-green) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Header --- */
        header { text-align: center; margin-top: 20px; }
        h1 { color: var(--dark-green); font-size: 3rem; margin-bottom: 5px; text-shadow: 2px 2px 0px #fff; letter-spacing: 2px; }
        
        .scoreboard {
            display: flex; gap: 20px; font-size: 1.2rem; font-weight: bold;
            background: white; padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); align-items: center;
        }
        .score-box span { color: var(--accent-orange); }

        /* Game Mode Selector */
        .mode-selector {
            display: flex; gap: 10px; align-items: center;
            background: white; padding: 10px 15px; border-radius: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 15px;
            flex-wrap: wrap; justify-content: center;
        }
        .mode-selector label { 
            font-weight: bold; color: var(--text-color); font-size: 0.9rem; 
            margin-right: 5px;
        }
        .mode-btn {
            padding: 8px 16px; border: 2px solid var(--primary-green);
            background: white; border-radius: 20px; cursor: pointer;
            font-weight: bold; transition: all 0.2s; font-size: 0.85rem;
        }
        .mode-btn:hover { background: var(--jungle-bg); }
        .mode-btn.active {
            background: var(--primary-green); color: white;
            border-color: var(--dark-green);
        }

        /* --- Game Area --- */
        #game-container {
            width: 90%; max-width: 800px; display: flex; flex-direction: column;
            align-items: center; margin-top: 20px; position: relative;
        }

        /* Score Popup */
        #turn-score-popup {
            position: absolute; top: 30%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--accent-orange); color: white;
            font-size: 3rem; font-weight: 900; padding: 20px 40px;
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 50; pointer-events: none; opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #turn-score-popup.active { transform: translate(-50%, -50%) scale(1); opacity: 1; }

        /* Animal Card */
        .animal-display {
            background: white; padding: 20px; border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); text-align: center;
            width: 100%; margin-bottom: 30px; border: 4px solid var(--primary-green);
            transition: transform 0.3s ease;
        }

        .animal-image {
            width: 250px; height: 250px; object-fit: cover;
            border-radius: 15px; margin: 0 auto 15px auto; display: block;
            border: 4px solid var(--dark-green); background-color: #eee;
        }

        .animal-name { 
            font-size: 2.5rem; font-weight: 800; color: var(--dark-green); 
            text-transform: uppercase; margin-bottom: 5px; 
        }

        /* Categories Grid */
        .categories-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px; width: 100%;
        }
        .category-card {
            background: var(--card-bg); border-radius: 15px; padding: 15px;
            cursor: pointer; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease; border-bottom: 5px solid #ddd;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; min-height: 100px;
        }
        .category-card:hover:not(.disabled) { 
            transform: translateY(-5px); border-bottom: 5px solid var(--primary-green); 
        }
        .category-card.disabled {
            background-color: #e0e0e0; color: #999; cursor: not-allowed;
            border-bottom: 5px solid #ccc; transform: none; opacity: 0.6;
        }

        /* Animations */
        @keyframes flashGreenAnim {
            0% { background-color: #fff; transform: scale(1); }
            50% { background-color: var(--primary-green); color: white; transform: scale(1.1); border-color: var(--dark-green); }
            100% { background-color: #fff; transform: scale(1); }
        }
        @keyframes flashRedAnim {
            0% { background-color: #fff; transform: scale(1); }
            50% { background-color: var(--danger-red); color: white; transform: scale(1.1); border-color: #c0392b; }
            100% { background-color: #fff; transform: scale(1); }
        }
        .flash-green { animation: flashGreenAnim 0.8s ease-in-out; }
        .flash-red { animation: flashRedAnim 0.8s ease-in-out; }

        /* Controls & Utils */
        .info-icon {
            position: absolute; top: 5px; right: 8px; font-size: 0.9rem; color: #999;
            width: 20px; height: 20px; border-radius: 50%; border: 1px solid #999;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .info-icon:hover { background: var(--accent-orange); color: white; border-color: var(--accent-orange); }
        
        .controls { margin-top: 40px; margin-bottom: 20px; }
        .btn-reset {
            background-color: #e74c3c; color: white; border: none; padding: 10px 25px;
            border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 1rem;
        }

        /* Modal */
        #description-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100;
            max-width: 300px; text-align: center; border: 4px solid var(--accent-orange);
        }
        #overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 99;
        }
    </style>
</head>
<body>

<header>
    <h1>ü¶Å ANIMAL KINGDOM</h1>
    <div class="scoreboard">
        <div class="score-box">Current: <span id="current-score">0</span></div>
        <div class="score-box">Best: <span id="high-score">0</span></div>
    </div>
    <div class="mode-selector">
        <label>Game Mode:</label>
        <button class="mode-btn active" onclick="setGameMode('classic')">ü¶Å Classic</button>
        <button class="mode-btn" onclick="setGameMode('dangerous')">üêØ Wild & Dangerous</button>
        <button class="mode-btn" onclick="setGameMode('connection')">üê∂ Human Connection</button>
    </div>
    <div class="mode-selector">
        <label>Animal Pool:</label>
        <button class="mode-btn pool-btn active" onclick="setPoolMode('random')">üé≤ Random</button>
        <button class="mode-btn pool-btn" onclick="setPoolMode('curated')">üèÜ Curated</button>
    </div>
</header>

<div id="game-container">
    <div id="turn-score-popup">+100</div>
    
    <div class="animal-display" id="animal-card">
        <img src="" alt="Animal" class="animal-image" id="animal-img">
        <div class="animal-name" id="animal-name">Loading...</div>
        <div style="margin-top:10px; color:#777; font-size: 1rem;">Select the best remaining category!</div>
    </div>

    <div class="categories-grid" id="categories-grid"></div>
    <div class="controls">
        <button class="btn-reset" onclick="resetGame()">Start Over üîÑ</button>
    </div>
</div>

<div id="overlay" onclick="closeModal()"></div>
<div id="description-modal">
    <h3 id="modal-title">Category</h3>
    <p id="modal-desc">Description goes here.</p>
    <button onclick="closeModal()" style="margin-top:10px; padding:5px 15px; cursor:pointer;">Close</button>
</div>

<script>
    if (typeof GAME_CONFIG === 'undefined') {
        alert("Error: data.js file not found! Make sure data.js is in the same folder.");
    }

    // Game Mode Configurations
    const GAME_MODES = {
        classic: {
            name: "Classic",
            description: "Balanced mix of danger, physical traits, and appeal",
            categoryIds: [1, 3, 4, 6, 8, 9, 12, 14],
            // Human Deaths, Top Speed, Lifespan, Habitat Extent, 
            // Consumption by Humans, Captivity Population, Bite Force, Cuteness
            icon: "ü¶Å"
        },
        dangerous: {
            name: "Wild & Dangerous",
            description: "Power, danger, and survival traits",
            categoryIds: [1, 12, 3, 18, 7, 13, 15, 10],
            // Human Deaths, Bite Force, Top Speed, Aggression Level,
            // Relative Strength, Social Behavior, Adaptability, Intelligence
            icon: "üêØ"
        },
        connection: {
            name: "Human Connection",
            description: "Cultural and social bonds with humanity",
            categoryIds: [14, 9, 11, 16, 17, 8, 10, 13],
            // Cuteness, Captivity Population, Cultural Significance, Economic Value,
            // Conservation Effort, Consumption by Humans, Intelligence, Social Behavior
            icon: "üê∂"
        }
    };

    // Current game mode (start with classic)
    let currentGameMode = 'classic';
    
    const GAME_DATA = GAME_CONFIG.animals;
    const ANIMAL_NAMES = Object.keys(GAME_DATA);

    // Calculate max possible score for each animal (only from current mode's categories)
    function getAnimalMaxScore(animalName) {
        const scores = GAME_DATA[animalName];
        let maxScore = 0;
        const allowedIds = GAME_MODES[currentGameMode].categoryIds;
        
        for (let catId of allowedIds) {
            // Check both string and number versions
            const score = scores[catId.toString()] || scores[catId];
            if (score !== undefined && score > maxScore) {
                maxScore = score;
            }
        }
        return maxScore;
    }

    // Get curated animal pool (animals where 8 picks can reach 600+)
    function getCuratedAnimalPool() {
        const animalScores = ANIMAL_NAMES.map(name => ({
            name: name,
            maxScore: getAnimalMaxScore(name)
        }));
        
        // Sort by max score descending
        animalScores.sort((a, b) => b.maxScore - a.maxScore);
        
        // Calculate what threshold is needed: 600 / 8 = 75 per pick
        // Filter animals that can contribute meaningfully (maxScore >= 75)
        const curatedAnimals = animalScores.filter(a => a.maxScore >= 75);
        
        console.log(`Curated pool for ${currentGameMode} mode: ${curatedAnimals.length} animals`);
        console.log(`Top 10:`, curatedAnimals.slice(0, 10).map(a => `${a.name} (${a.maxScore})`).join(', '));
        
        return curatedAnimals.map(a => a.name);
    }

    let state = {
        currentScore: 0,
        highScore: localStorage.getItem('animalKingdomHighScore') || 0,
        usedCategoryIds: [],
        availableAnimals: [],
        currentAnimal: null,
        isProcessing: false,
        gameOver: false,
        poolMode: 'random', // 'random' or 'curated'
        curatedPool: []
    };

    function setGameMode(mode) {
        if (state.isProcessing) return;
        
        currentGameMode = mode;
        
        // Update button styles
        document.querySelectorAll('.mode-btn:not(.pool-btn)').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Recalculate curated pool for new mode
        state.curatedPool = getCuratedAnimalPool();
        
        // Rebuild category grid with new mode's categories
        rebuildCategoryGrid();
        
        // Reset game
        resetGame();
    }
    
    function setPoolMode(mode) {
        if (state.isProcessing) return;
        
        state.poolMode = mode;
        
        // Update button styles
        document.querySelectorAll('.pool-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Reset game with new pool mode
        resetGame();
    }
    
    function rebuildCategoryGrid() {
        const grid = document.getElementById('categories-grid');
        grid.innerHTML = '';
        
        // Get categories for current mode
        const allowedIds = GAME_MODES[currentGameMode].categoryIds;
        const modeCategories = GAME_CONFIG.categories.filter(cat => {
            // Convert both to numbers for comparison (handles string vs number mismatch)
            const catId = typeof cat.id === 'string' ? parseInt(cat.id) : cat.id;
            return allowedIds.includes(catId);
        });
        
        console.log(`Found ${modeCategories.length} categories for ${currentGameMode} mode`);
        
        modeCategories.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'category-card';
            btn.id = `cat-${cat.id}`;
            btn.onclick = () => selectCategory(cat.id);
            btn.innerHTML = `
                <div class="info-icon" onclick="showInfo(event, '${cat.name}', '${cat.desc}')">i</div>
                <strong>${cat.name}</strong>
            `;
            grid.appendChild(btn);
        });
    }

    function initGame() {
        // Build initial category grid
        rebuildCategoryGrid();
        
        // Set high score
        document.getElementById('high-score').innerText = state.highScore;
        
        // Initialize curated pool
        state.curatedPool = getCuratedAnimalPool();
        
        // Start game
        resetGame();
    }

    function resetGame() {
        state.currentScore = 0;
        state.usedCategoryIds = [];
        state.gameOver = false;
        state.isProcessing = false;
        
        // Select animal pool based on pool mode
        if (state.poolMode === 'curated') {
            // Use only high-scoring animals for current mode
            state.availableAnimals = [...state.curatedPool];
            
            // Ensure we have at least 8 animals
            if (state.availableAnimals.length < 8) {
                console.warn('Not enough high-scoring animals, using all animals');
                state.availableAnimals = [...ANIMAL_NAMES];
            }
        } else {
            // Random mode: use all animals
            state.availableAnimals = [...ANIMAL_NAMES];
        }
        
        console.log(`Starting game: ${currentGameMode} mode, ${state.poolMode} pool (${state.availableAnimals.length} animals)`);
        
        document.getElementById('current-score').innerText = '0';
        document.querySelectorAll('.category-card').forEach(card => card.className = 'category-card');
        nextTurn();
    }

    function nextTurn() {
        document.querySelectorAll('.category-card').forEach(card => {
            card.classList.remove('flash-green', 'flash-red');
        });

        // Check if game is over (all categories used or no animals left)
        const currentModeCategoryCount = GAME_MODES[currentGameMode].categoryIds.length;
        if (state.usedCategoryIds.length >= currentModeCategoryCount || state.availableAnimals.length === 0) {
            endGame();
            return;
        }

        state.isProcessing = false;
        const randomIndex = Math.floor(Math.random() * state.availableAnimals.length);
        state.currentAnimal = state.availableAnimals[randomIndex];
        state.availableAnimals.splice(randomIndex, 1);
        
        const animalData = GAME_DATA[state.currentAnimal];
        const imgEl = document.getElementById('animal-img');
        const nameEl = document.getElementById('animal-name');

        nameEl.innerText = state.currentAnimal;
        
        if (animalData && animalData.image) {
            imgEl.src = animalData.image;
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }
        
        const card = document.getElementById('animal-card');
        card.style.transform = "scale(0.95)";
        setTimeout(() => card.style.transform = "scale(1)", 200);
    }

    function getBestCategoryForAnimal(animalName) {
        const scores = GAME_DATA[animalName];
        let bestCat = "";
        let maxScore = -1;
        const allowedIds = GAME_MODES[currentGameMode].categoryIds;

        for (let catId of allowedIds) {
            const catIdStr = catId.toString();
            if (!state.usedCategoryIds.includes(catIdStr) && !state.usedCategoryIds.includes(catId)) {
                // Check both string and number versions
                const score = scores[catIdStr] || scores[catId];
                if (score !== undefined && score > maxScore) {
                    maxScore = score;
                    bestCat = catIdStr;
                }
            }
        }
        return { id: bestCat, score: maxScore };
    }

    function selectCategory(catId) {
        if (state.gameOver || state.isProcessing) return;
        
        // Convert to string for consistent comparison
        const catIdStr = catId.toString();
        if (state.usedCategoryIds.includes(catIdStr) || state.usedCategoryIds.includes(catId)) return;

        state.isProcessing = true;

        // Check both string and number versions for score lookup
        const score = GAME_DATA[state.currentAnimal][catIdStr] || GAME_DATA[state.currentAnimal][catId];
        const bestOption = getBestCategoryForAnimal(state.currentAnimal);
        const chosenCard = document.getElementById(`cat-${catId}`);
        const bestCard = document.getElementById(`cat-${bestOption.id}`);

        if (catIdStr === bestOption.id || catId == bestOption.id) {
            chosenCard.classList.add('flash-green');
        } else {
            chosenCard.classList.add('flash-red');
            if(bestCard) bestCard.classList.add('flash-green');
        }

        showScorePopup(score);

        state.currentScore += score;
        state.usedCategoryIds.push(catIdStr);
        document.getElementById('current-score').innerText = state.currentScore;
        
        chosenCard.classList.add('disabled');
        setTimeout(nextTurn, 1200);
    }

    function showScorePopup(score) {
        const popup = document.getElementById('turn-score-popup');
        popup.innerText = `+${score}`;
        popup.classList.add('active');
        setTimeout(() => popup.classList.remove('active'), 1000);
    }

    function endGame() {
        state.gameOver = true;
        const modeText = state.gameMode === 'curated' ? ' (Curated Mode)' : '';
        
        if (state.currentScore > state.highScore) {
            state.highScore = state.currentScore;
            localStorage.setItem('animalKingdomHighScore', state.highScore);
            document.getElementById('high-score').innerText = state.highScore;
            alert(`üéâ NEW RECORD${modeText}!\nFinal Score: ${state.currentScore}`);
        } else {
            alert(`Game Over${modeText}!\nFinal Score: ${state.currentScore}`);
        }
    }

    function showInfo(event, title, desc) {
        event.stopPropagation();
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-desc').innerText = desc;
        document.getElementById('description-modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('description-modal').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    initGame();
</script>
</body>
</html>