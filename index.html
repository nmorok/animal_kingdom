<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Kingdom ü¶Å</title>
    <script src="data.js"></script> 
    <style>
        :root {
            --primary-green: #2ecc71;
            --dark-green: #27ae60;
            --jungle-bg: #e8f5e9;
            --accent-orange: #f39c12;
            --danger-red: #e74c3c;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--jungle-bg);
            background-image: radial-gradient(var(--primary-green) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Header --- */
        header { text-align: center; margin-top: 20px; }
        h1 { color: var(--dark-green); font-size: 3rem; margin-bottom: 5px; text-shadow: 2px 2px 0px #fff; letter-spacing: 2px; }
        
        .scoreboard {
            display: flex; gap: 20px; font-size: 1.2rem; font-weight: bold;
            background: white; padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); align-items: center;
        }
        .score-box span { color: var(--accent-orange); }

        /* Game Mode Selector */
        .mode-selector {
            display: flex; gap: 10px; align-items: center;
            background: white; padding: 10px 15px; border-radius: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 15px;
            flex-wrap: wrap; justify-content: center;
        }
        .mode-selector label { 
            font-weight: bold; color: var(--text-color); font-size: 0.9rem; 
            margin-right: 5px;
        }
        .mode-btn {
            padding: 8px 16px; border: 2px solid var(--primary-green);
            background: white; border-radius: 20px; cursor: pointer;
            font-weight: bold; transition: all 0.2s; font-size: 0.85rem;
        }
        .mode-btn:hover { background: var(--jungle-bg); }
        .mode-btn.active {
            background: var(--primary-green); color: white;
            border-color: var(--dark-green);
        }

        /* --- Game Area --- */
        #game-container {
            width: 90%; max-width: 800px; display: flex; flex-direction: column;
            align-items: center; margin-top: 20px; position: relative;
        }

        /* Score Popup */
        #turn-score-popup {
            position: absolute; top: 30%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--accent-orange); color: white;
            font-size: 3rem; font-weight: 900; padding: 20px 40px;
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 50; pointer-events: none; opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #turn-score-popup.active { transform: translate(-50%, -50%) scale(1); opacity: 1; }

        /* Animal Card */
        .animal-display {
            background: white; padding: 20px; border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); text-align: center;
            width: 100%; margin-bottom: 30px; border: 4px solid var(--primary-green);
            transition: transform 0.3s ease;
        }

        .animal-image {
            width: 250px; height: 250px; object-fit: cover;
            border-radius: 15px; margin: 0 auto 15px auto; display: block;
            border: 4px solid var(--dark-green); background-color: #eee;
        }

        .animal-name { 
            font-size: 2.5rem; font-weight: 800; color: var(--dark-green); 
            text-transform: uppercase; margin-bottom: 5px; 
        }

        /* Categories Grid */
        .categories-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px; width: 100%;
        }
        .category-card {
            background: var(--card-bg); border-radius: 15px; padding: 15px;
            cursor: pointer; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease; border-bottom: 5px solid #ddd;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; min-height: 100px;
        }
        .category-card:hover:not(.disabled) { 
            transform: translateY(-5px); border-bottom: 5px solid var(--primary-green); 
        }
        .category-card.disabled {
            background-color: #e0e0e0; color: #999; cursor: not-allowed;
            border-bottom: 5px solid #ccc; transform: none; opacity: 0.6;
        }

        /* Animations */
        @keyframes flashGreenAnim {
            0% { background-color: #fff; transform: scale(1); }
            50% { background-color: var(--primary-green); color: white; transform: scale(1.1); border-color: var(--dark-green); }
            100% { background-color: #fff; transform: scale(1); }
        }
        @keyframes flashRedAnim {
            0% { background-color: #fff; transform: scale(1); }
            50% { background-color: var(--danger-red); color: white; transform: scale(1.1); border-color: #c0392b; }
            100% { background-color: #fff; transform: scale(1); }
        }
        .flash-green { animation: flashGreenAnim 0.8s ease-in-out; }
        .flash-red { animation: flashRedAnim 0.8s ease-in-out; }

        /* Controls & Utils */
        .info-icon {
            position: absolute; top: 5px; right: 8px; font-size: 0.9rem; color: #999;
            width: 20px; height: 20px; border-radius: 50%; border: 1px solid #999;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .info-icon:hover { background: var(--accent-orange); color: white; border-color: var(--accent-orange); }
        
        .controls { margin-top: 40px; margin-bottom: 20px; }
        .btn-reset {
            background-color: #e74c3c; color: white; border: none; padding: 10px 25px;
            border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 1rem;
        }

        /* Modal */
        #description-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100;
            max-width: 300px; text-align: center; border: 4px solid var(--accent-orange);
        }
        #overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 99;
        }

        /* Rules Button */
        .rules-btn {
            background: var(--accent-orange); color: white; border: none;
            padding: 12px 24px; border-radius: 30px; font-weight: bold;
            cursor: pointer; font-size: 1rem; margin-top: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        .rules-btn:hover {
            background: #e67e22; transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* Rules Modal */
        #rules-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; overflow-y: auto;
        }
        .rules-content {
            background: white; border-radius: 20px; padding: 40px;
            max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .rules-content h2 {
            color: var(--dark-green); margin-top: 0; font-size: 2rem;
            text-align: center; margin-bottom: 30px;
        }
        .rules-content h3 {
            color: var(--primary-green); font-size: 1.3rem; margin-top: 25px;
            margin-bottom: 10px;
        }
        .rules-section {
            margin-bottom: 25px; line-height: 1.6;
        }
        .rules-section p {
            margin: 8px 0; color: var(--text-color);
        }
        .rules-section ol {
            margin: 10px 0; padding-left: 25px;
        }
        .rules-section li {
            margin: 8px 0;
        }
        .rules-close {
            position: absolute; top: 15px; right: 20px; font-size: 2rem;
            cursor: pointer; color: #999; font-weight: bold;
            width: 35px; height: 35px; display: flex; align-items: center;
            justify-content: center; border-radius: 50%; transition: all 0.2s;
        }
        .rules-close:hover {
            background: var(--danger-red); color: white;
        }
        .start-btn {
            background: var(--primary-green); color: white; border: none;
            padding: 15px 40px; border-radius: 30px; font-weight: bold;
            cursor: pointer; font-size: 1.1rem; margin-top: 20px;
            display: block; width: 100%; max-width: 300px; margin-left: auto;
            margin-right: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .start-btn:hover {
            background: var(--dark-green); transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<header>
    <h1>ü¶Å ANIMAL KINGDOM</h1>
    <div class="scoreboard">
        <div class="score-box">Current: <span id="current-score">0</span></div>
        <div class="score-box">Best: <span id="high-score">0</span></div>
    </div>
    <div class="mode-selector">
        <label>Game Mode:</label>
        <button class="mode-btn active" onclick="setGameMode('classic')">ü¶Å Classic</button>
        <button class="mode-btn" onclick="setGameMode('dangerous')">üêØ Wild & Dangerous</button>
        <button class="mode-btn" onclick="setGameMode('connection')">üê∂ Human Connection</button>
        <button class="mode-btn" onclick="setGameMode('random')">üé≤ Random</button>
        <button class="mode-btn" onclick="setGameMode('daily')">üìÖ Daily Challenge</button>
    </div>
    <div class="mode-selector" id="pool-selector">
        <label>Animal Pool:</label>
        <button class="mode-btn pool-btn active" onclick="setPoolMode('random')">üé≤ Random</button>
        <button class="mode-btn pool-btn" onclick="setPoolMode('curated')">üèÜ Curated</button>
    </div>
    <button class="rules-btn" onclick="openRules()">‚ùì How to Play</button>
</header>

<div id="game-container">
    <div id="turn-score-popup">+100</div>
    
    <div class="animal-display" id="animal-card">
        <img src="" alt="Animal" class="animal-image" id="animal-img">
        <div class="animal-name" id="animal-name">Loading...</div>
        <div style="margin-top:10px; color:#777; font-size: 1rem;">Select the best remaining category!</div>
    </div>

    <div class="categories-grid" id="categories-grid"></div>
    <div class="controls">
        <button class="btn-reset" onclick="resetGame()">Start Over üîÑ</button>
    </div>
</div>

<div id="overlay" onclick="closeModal()"></div>
<div id="description-modal">
    <h3 id="modal-title">Category</h3>
    <p id="modal-desc">Description goes here.</p>
    <button onclick="closeModal()" style="margin-top:10px; padding:5px 15px; cursor:pointer;">Close</button>
</div>

<!-- Rules Modal -->
<div id="rules-modal" style="display: none;">
    <div class="rules-content">
        <span class="rules-close" onclick="closeRules()">&times;</span>
        <h2>üéÆ How to Play Animal Kingdom</h2>
        
        <div class="rules-section">
            <h3>üéØ Goal</h3>
            <p>Guess which animal has a <strong>higher value</strong> for the randomly selected category!</p>
        </div>

        <div class="rules-section">
            <h3>üé≤ Gameplay</h3>
            <ol>
                <li>You'll see one animal and available categories</li>
                <li>Pick the <strong>best category</strong> for that animal (highest score)</li>
                <li>The game reveals if it was the best choice</li>
                <li>Keep going until you pick wrong or run out of categories!</li>
            </ol>
        </div>

        <div class="rules-section">
            <h3>üé≠ Game Modes</h3>
            <p><strong>ü¶Å Classic:</strong> Balanced mix of categories - speed, lifespan, cuteness, and more!</p>
            <p><strong>üêØ Wild & Dangerous:</strong> Focus on power, danger, and survival traits.</p>
            <p><strong>üê∂ Human Connection:</strong> Cultural bonds, pets, livestock, and familiar animals.</p>
            <p><strong>üé≤ Random:</strong> 8 random categories from all 22 - completely unpredictable!</p>
            <p><strong>üìÖ Daily Challenge:</strong> Same 8 animals & categories for everyone. Can you get them all?</p>
        </div>

        <div class="rules-section">
            <h3>üé≤ Animal Pools</h3>
            <p><strong>Random:</strong> Any animal can appear - from ants to elephants!</p>
            <p><strong>Curated:</strong> Hand-picked interesting matchups for better gameplay.</p>
        </div>

        <div class="rules-section">
            <h3>üìä Scoring</h3>
            <p>‚Ä¢ Each category has animals scored 0-100 relative to each other</p>
            <p>‚Ä¢ Your job: pick the category where your animal scores highest!</p>
            <p>‚Ä¢ Perfect game = get all categories correct in order</p>
            <p>‚Ä¢ <strong>Daily Challenge:</strong> Get the optimal score to see the best possible result!</p>
        </div>

        <div class="rules-section">
            <h3>üí° Pro Tips</h3>
            <p>‚Ä¢ Mosquitoes are deadlier than sharks (they spread diseases!)</p>
            <p>‚Ä¢ "Lightest" and "Smallest" mean light/small = high score</p>
            <p>‚Ä¢ Some animals surprise you - coral can live thousands of years!</p>
            <p>‚Ä¢ In Daily Challenge, order matters - match animals to their best categories!</p>
        </div>

        <button class="start-btn" onclick="closeRules()">Got it! Let's Play üéÆ</button>
    </div>
</div>

<script>
    if (typeof GAME_CONFIG === 'undefined') {
        alert("Error: data.js file not found! Make sure data.js is in the same folder.");
    }

    // Game Mode Configurations
    const GAME_MODES = {
        classic: {
            name: "Classic",
            description: "Balanced mix of danger, physical traits, and appeal",
            categoryIds: [1, 3, 4, 6, 8, 9, 12, 14],
            // Human Deaths, Top Speed, Lifespan, Habitat Extent, 
            // Consumption by Humans, Captivity Population, Bite Force, Cuteness
            icon: "ü¶Å"
        },
        dangerous: {
            name: "Wild & Dangerous",
            description: "Power, danger, and survival traits",
            categoryIds: [1, 12, 3, 18, 7, 13, 15, 10],
            // Human Deaths, Bite Force, Top Speed, Aggression Level,
            // Relative Strength, Social Behavior, Adaptability, Intelligence
            icon: "üêØ"
        },
        connection: {
            name: "Human Connection",
            description: "Cultural and social bonds with humanity",
            categoryIds: [14, 9, 11, 16, 17, 8, 10, 13],
            // Cuteness, Captivity Population, Cultural Significance, Economic Value,
            // Conservation Effort, Consumption by Humans, Intelligence, Social Behavior
            icon: "üê∂"
        },
        random: {
            name: "Random",
            description: "8 random categories from all 22 available - different every game!",
            categoryIds: null, // Will be randomly selected
            icon: "üé≤",
            isRandom: true
        },
        daily: {
            name: "Daily Challenge",
            description: "Same animals and categories for everyone today!",
            categoryIds: null, // Will be set daily
            icon: "üìÖ",
            isDaily: true
        }
    };

    // Current game mode (start with classic)
    let currentGameMode = 'classic';
    let dailyChallenge = null; // Will hold today's daily challenge data
    
    const GAME_DATA = GAME_CONFIG.animals;
    const ANIMAL_NAMES = Object.keys(GAME_DATA);

    // Seeded Random Number Generator (for daily challenges)
    class SeededRandom {
        constructor(seed) {
            this.seed = seed;
        }
        
        next() {
            this.seed = (this.seed * 9301 + 49297) % 233280;
            return this.seed / 233280;
        }
        
        shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(this.next() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
    }

    // Generate today's daily challenge
    function generateDailyChallenge() {
        const today = new Date();
        const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        // Convert date string to seed
        let seed = 0;
        for (let i = 0; i < dateStr.length; i++) {
            seed = (seed * 31 + dateStr.charCodeAt(i)) % 1000000;
        }
        
        const rng = new SeededRandom(seed);
        
        // Pick 8 random categories from all 18
        const allCategoryIds = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18];
        const shuffledCategories = rng.shuffle(allCategoryIds);
        const selectedCategories = shuffledCategories.slice(0, 8);
        
        // Pick 8 random animals from all animals
        const shuffledAnimals = rng.shuffle(ANIMAL_NAMES);
        const selectedAnimals = shuffledAnimals.slice(0, 8);
        
        console.log(`üìÖ Daily Challenge for ${dateStr}`);
        console.log('Categories:', selectedCategories);
        console.log('Animals:', selectedAnimals);
        
        return {
            date: dateStr,
            seed: seed,
            categoryIds: selectedCategories,
            animalNames: selectedAnimals
        };
    }

    // Calculate optimal score for daily challenge
    function calculateOptimalScore(animals, categoryIds) {
        let optimalScore = 0;
        const optimalMoves = [];
        
        // For each animal, find its best category from available categories
        const usedCategories = new Set();
        const animalScores = [];
        
        // Build matrix of scores
        for (const animal of animals) {
            const scores = [];
            for (const catId of categoryIds) {
                const score = GAME_DATA[animal][catId.toString()] || GAME_DATA[animal][catId] || 0;
                scores.push({ catId, score });
            }
            animalScores.push({ animal, scores });
        }
        
        // Greedy assignment: repeatedly pick the highest remaining score
        const remainingAnimals = new Set(animals);
        const remainingCategories = new Set(categoryIds);
        
        while (remainingAnimals.size > 0 && remainingCategories.size > 0) {
            let bestScore = -1;
            let bestAnimal = null;
            let bestCategory = null;
            
            // Find the best (animal, category) pair
            for (const animal of remainingAnimals) {
                for (const catId of remainingCategories) {
                    const score = GAME_DATA[animal][catId.toString()] || GAME_DATA[animal][catId] || 0;
                    if (score > bestScore) {
                        bestScore = score;
                        bestAnimal = animal;
                        bestCategory = catId;
                    }
                }
            }
            
            if (bestAnimal && bestCategory) {
                optimalScore += bestScore;
                optimalMoves.push({ animal: bestAnimal, category: bestCategory, score: bestScore });
                remainingAnimals.delete(bestAnimal);
                remainingCategories.delete(bestCategory);
            } else {
                break;
            }
        }
        
        return { optimalScore, optimalMoves };
    }

    // Calculate max possible score for each animal (only from current mode's categories)
    function getAnimalMaxScore(animalName) {
        const scores = GAME_DATA[animalName];
        let maxScore = 0;
        const allowedIds = GAME_MODES[currentGameMode].categoryIds;
        
        for (let catId of allowedIds) {
            // Check both string and number versions
            const score = scores[catId.toString()] || scores[catId];
            if (score !== undefined && score > maxScore) {
                maxScore = score;
            }
        }
        return maxScore;
    }

    // Get curated animal pool (animals where 8 picks can reach 600+)
    function getCuratedAnimalPool() {
        const animalScores = ANIMAL_NAMES.map(name => ({
            name: name,
            maxScore: getAnimalMaxScore(name)
        }));
        
        // Sort by max score descending
        animalScores.sort((a, b) => b.maxScore - a.maxScore);
        
        // Calculate what threshold is needed: 600 / 8 = 75 per pick
        // Filter animals that can contribute meaningfully (maxScore >= 75)
        const curatedAnimals = animalScores.filter(a => a.maxScore >= 75);
        
        console.log(`Curated pool for ${currentGameMode} mode: ${curatedAnimals.length} animals`);
        console.log(`Top 10:`, curatedAnimals.slice(0, 10).map(a => `${a.name} (${a.maxScore})`).join(', '));
        
        return curatedAnimals.map(a => a.name);
    }

    let state = {
        currentScore: 0,
        highScore: localStorage.getItem('animalKingdomHighScore') || 0,
        usedCategoryIds: [],
        availableAnimals: [],
        currentAnimal: null,
        isProcessing: false,
        gameOver: false,
        poolMode: 'random', // 'random' or 'curated'
        curatedPool: [],
        isDailyMode: false,
        dailyOptimal: null // Stores optimal score/moves for daily mode
    };

    function setGameMode(mode) {
        if (state.isProcessing) return;
        
        currentGameMode = mode;
        
        // Update button styles
        document.querySelectorAll('.mode-btn:not(.pool-btn)').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Handle random mode - randomly select 8 categories from all 22
        if (mode === 'random') {
            const allCategoryIds = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
            const shuffled = allCategoryIds.sort(() => Math.random() - 0.5);
            const randomCategories = shuffled.slice(0, 8);
            GAME_MODES.random.categoryIds = randomCategories;
            console.log('üé≤ Random categories selected:', randomCategories);
            
            state.isDailyMode = false;
            state.dailyOptimal = null;
            
            // Show pool selector for random mode
            document.getElementById('pool-selector').style.display = 'flex';
            
            // Recalculate curated pool
            state.curatedPool = getCuratedAnimalPool();
        }
        // Handle daily challenge mode
        else if (mode === 'daily') {
            state.isDailyMode = true;
            dailyChallenge = generateDailyChallenge();
            GAME_MODES.daily.categoryIds = dailyChallenge.categoryIds;
            
            // Calculate optimal score for this daily challenge
            state.dailyOptimal = calculateOptimalScore(dailyChallenge.animalNames, dailyChallenge.categoryIds);
            console.log(`Optimal score for today: ${state.dailyOptimal.optimalScore}`);
            
            // Hide pool selector in daily mode
            document.getElementById('pool-selector').style.display = 'none';
        } else {
            state.isDailyMode = false;
            state.dailyOptimal = null;
            
            // Show pool selector for other modes
            document.getElementById('pool-selector').style.display = 'flex';
            
            // Recalculate curated pool for new mode
            state.curatedPool = getCuratedAnimalPool();
        }
        
        // Rebuild category grid with new mode's categories
        rebuildCategoryGrid();
        
        // Reset game
        resetGame();
    }
    
    function setPoolMode(mode) {
        if (state.isProcessing) return;
        
        state.poolMode = mode;
        
        // Update button styles
        document.querySelectorAll('.pool-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Reset game with new pool mode
        resetGame();
    }
    
    function rebuildCategoryGrid() {
        const grid = document.getElementById('categories-grid');
        grid.innerHTML = '';
        
        // Get categories for current mode
        const allowedIds = GAME_MODES[currentGameMode].categoryIds;
        const modeCategories = GAME_CONFIG.categories.filter(cat => {
            // Convert both to numbers for comparison (handles string vs number mismatch)
            const catId = typeof cat.id === 'string' ? parseInt(cat.id) : cat.id;
            return allowedIds.includes(catId);
        });
        
        console.log(`Found ${modeCategories.length} categories for ${currentGameMode} mode`);
        
        modeCategories.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'category-card';
            btn.id = `cat-${cat.id}`;
            btn.onclick = () => selectCategory(cat.id);
            btn.innerHTML = `
                <div class="info-icon" onclick="showInfo(event, '${cat.name}', '${cat.desc}')">i</div>
                <strong>${cat.name}</strong>
            `;
            grid.appendChild(btn);
        });
    }

    function initGame() {
        // Build initial category grid
        rebuildCategoryGrid();
        
        // Set high score
        document.getElementById('high-score').innerText = state.highScore;
        
        // Initialize curated pool
        state.curatedPool = getCuratedAnimalPool();
        
        // Start game
        resetGame();
    }

    function resetGame() {
        state.currentScore = 0;
        state.usedCategoryIds = [];
        state.gameOver = false;
        state.isProcessing = false;
        
        // Select animal pool based on mode
        if (state.isDailyMode && dailyChallenge) {
            // Use today's fixed animals for daily challenge
            state.availableAnimals = [...dailyChallenge.animalNames];
            console.log(`Starting Daily Challenge: ${dailyChallenge.date}`);
            console.log(`Animals: ${state.availableAnimals.join(', ')}`);
            console.log(`Optimal possible score: ${state.dailyOptimal.optimalScore}`);
        } else if (state.poolMode === 'curated') {
            // Use only high-scoring animals for current mode
            state.availableAnimals = [...state.curatedPool];
            
            // Ensure we have at least 8 animals
            if (state.availableAnimals.length < 8) {
                console.warn('Not enough high-scoring animals, using all animals');
                state.availableAnimals = [...ANIMAL_NAMES];
            }
        } else {
            // Random mode: use all animals
            state.availableAnimals = [...ANIMAL_NAMES];
        }
        
        console.log(`Starting game: ${currentGameMode} mode, ${state.isDailyMode ? 'daily challenge' : state.poolMode + ' pool'} (${state.availableAnimals.length} animals)`);
        
        document.getElementById('current-score').innerText = '0';
        document.querySelectorAll('.category-card').forEach(card => card.className = 'category-card');
        nextTurn();
    }

    function nextTurn() {
        document.querySelectorAll('.category-card').forEach(card => {
            card.classList.remove('flash-green', 'flash-red');
        });

        // Check if game is over (all categories used or no animals left)
        const currentModeCategoryCount = GAME_MODES[currentGameMode].categoryIds.length;
        if (state.usedCategoryIds.length >= currentModeCategoryCount || state.availableAnimals.length === 0) {
            endGame();
            return;
        }

        state.isProcessing = false;
        
        // In daily mode, use animals in fixed order. In other modes, random.
        let animalIndex;
        if (state.isDailyMode) {
            animalIndex = 0; // Always take first animal (they're already in order)
        } else {
            animalIndex = Math.floor(Math.random() * state.availableAnimals.length);
        }
        
        state.currentAnimal = state.availableAnimals[animalIndex];
        state.availableAnimals.splice(animalIndex, 1);
        
        const animalData = GAME_DATA[state.currentAnimal];
        const imgEl = document.getElementById('animal-img');
        const nameEl = document.getElementById('animal-name');

        nameEl.innerText = state.currentAnimal;
        
        if (animalData && animalData.image) {
            imgEl.src = animalData.image;
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }
        
        const card = document.getElementById('animal-card');
        card.style.transform = "scale(0.95)";
        setTimeout(() => card.style.transform = "scale(1)", 200);
    }

    function getBestCategoryForAnimal(animalName) {
        const scores = GAME_DATA[animalName];
        let bestCat = "";
        let maxScore = -1;
        const allowedIds = GAME_MODES[currentGameMode].categoryIds;

        for (let catId of allowedIds) {
            const catIdStr = catId.toString();
            if (!state.usedCategoryIds.includes(catIdStr) && !state.usedCategoryIds.includes(catId)) {
                // Check both string and number versions
                const score = scores[catIdStr] || scores[catId];
                if (score !== undefined && score > maxScore) {
                    maxScore = score;
                    bestCat = catIdStr;
                }
            }
        }
        return { id: bestCat, score: maxScore };
    }

    function selectCategory(catId) {
        if (state.gameOver || state.isProcessing) return;
        
        // Convert to string for consistent comparison
        const catIdStr = catId.toString();
        if (state.usedCategoryIds.includes(catIdStr) || state.usedCategoryIds.includes(catId)) return;

        state.isProcessing = true;

        // Check both string and number versions for score lookup
        const score = GAME_DATA[state.currentAnimal][catIdStr] || GAME_DATA[state.currentAnimal][catId];
        const bestOption = getBestCategoryForAnimal(state.currentAnimal);
        const chosenCard = document.getElementById(`cat-${catId}`);
        const bestCard = document.getElementById(`cat-${bestOption.id}`);

        if (catIdStr === bestOption.id || catId == bestOption.id) {
            chosenCard.classList.add('flash-green');
        } else {
            chosenCard.classList.add('flash-red');
            if(bestCard) bestCard.classList.add('flash-green');
        }

        showScorePopup(score);

        state.currentScore += score;
        state.usedCategoryIds.push(catIdStr);
        document.getElementById('current-score').innerText = state.currentScore;
        
        chosenCard.classList.add('disabled');
        setTimeout(nextTurn, 1200);
    }

    function showScorePopup(score) {
        const popup = document.getElementById('turn-score-popup');
        popup.innerText = `+${score}`;
        popup.classList.add('active');
        setTimeout(() => popup.classList.remove('active'), 1000);
    }

    function endGame() {
        state.gameOver = true;
        
        if (state.isDailyMode && state.dailyOptimal) {
            // Show daily challenge results with optimal score
            const efficiency = Math.round((state.currentScore / state.dailyOptimal.optimalScore) * 100);
            let message = `üìÖ Daily Challenge Complete!\n\n`;
            message += `Your Score: ${state.currentScore}\n`;
            message += `Optimal Score: ${state.dailyOptimal.optimalScore}\n`;
            message += `Efficiency: ${efficiency}%\n\n`;
            
            if (efficiency === 100) {
                message += `üèÜ PERFECT! You found the optimal solution!`;
            } else if (efficiency >= 90) {
                message += `üåü Excellent! Very close to optimal!`;
            } else if (efficiency >= 75) {
                message += `üëç Good job! Room for improvement.`;
            } else {
                message += `Keep practicing! Try to maximize each pick.`;
            }
            
            message += `\n\n--- Optimal Solution ---\n`;
            state.dailyOptimal.optimalMoves.forEach((move, idx) => {
                const catName = GAME_CONFIG.categories.find(c => c.id == move.category)?.name || `Cat ${move.category}`;
                message += `${idx + 1}. ${move.animal} ‚Üí ${catName}: ${move.score}\n`;
            });
            
            alert(message);
        } else {
            // Regular mode
            const modeText = state.poolMode === 'curated' ? ' (Curated)' : '';
            
            if (state.currentScore > state.highScore) {
                state.highScore = state.currentScore;
                localStorage.setItem('animalKingdomHighScore', state.highScore);
                document.getElementById('high-score').innerText = state.highScore;
                alert(`üéâ NEW RECORD${modeText}!\nFinal Score: ${state.currentScore}`);
            } else {
                alert(`Game Over${modeText}!\nFinal Score: ${state.currentScore}`);
            }
        }
    }

    function showInfo(event, title, desc) {
        event.stopPropagation();
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-desc').innerText = desc;
        document.getElementById('description-modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('description-modal').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function openRules() {
        document.getElementById('rules-modal').style.display = 'flex';
    }

    function closeRules() {
        document.getElementById('rules-modal').style.display = 'none';
    }

    initGame();
</script>
</body>
</html>